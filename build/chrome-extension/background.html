<script>
/* See license.txt for terms of usage */

// *************************************************************************************************

var firebugVersion = "Firebug Lite 1.3a5";
var bookmarlet = "javascript:(typeof Firebug!='undefined')?Firebug.chrome.toggle():(function(F,B,L){L=F.createElement('script');L.id='FirebugLite';L.src=B;F.getElementsByTagName('head')[0].appendChild(L);})(document,'https://getfirebug.com/releases/lite/alpha/firebug.jgz#startOpened,showIconWhenHidden=false');";

var active = false;

// *************************************************************************************************

function handleIconClick(tab)
{
    if (tab.url.indexOf("https://chrome.google.com/extensions") == 0)
    {
        chrome.tabs.update(tab.id, {url: bookmarlet});
        
        if (!active)
        {
            chrome.browserAction.setTitle({title: firebugVersion + " (On)"});
            chrome.browserAction.setIcon({path:"firebug24.png"});
            active = true;
        }
        
        return;
    }
    
    chrome.tabs.sendRequest( tab.id, {name: "FB_isActive"}, 
    
        function(response)
        {
            if (response.value == "true")
            {
                chrome.tabs.update(tab.id, {url: "javascript:Firebug.chrome.toggle()"});
            }
            else
            {
                activateFirebug(tab);
                chrome.tabs.sendRequest(tab.id, {name: "FB_loadFirebug"});
            }
        }
    );
};

chrome.browserAction.onClicked.addListener(handleIconClick);

// *************************************************************************************************

function handleTabChange(tabId, selectInfo)
{
    disableIcon();
    active = false;
    
    chrome.tabs.sendRequest(tabId, {name: "FB_isActive"}, 
    
        function(response)
        {
            if (response.value == "true")
            {
                enableIcon();
                active = true;
            }
            else
            {
            }
        }
    );
};

// *************************************************************************************************

chrome.tabs.onSelectionChanged.addListener(handleTabChange);

// *************************************************************************************************

chrome.tabs.onUpdated.addListener
( 
    function(tabId, updateInfo, tab)
    {
        if (updateInfo.status == "complete") return;
        
        handleTabChange(tabId, updateInfo);
    }
);

// *************************************************************************************************

chrome.extension.onRequest.addListener
(
    function(request, sender, sendResponse)
    {
        if (request.name == "FB_enableIcon")
            enableIcon();
        
        else if (request.name == "FB_disableIcon")
            disableIcon();
          
        sendResponse({}); // snub them.
    }
);

// *************************************************************************************************

function enableIcon()
{
    chrome.browserAction.setTitle({title: firebugVersion + " (On)"});
    chrome.browserAction.setIcon({path:"firebug24.png"});
};

function disableIcon()
{
    chrome.browserAction.setTitle({title: firebugVersion + " (Off)"});
    chrome.browserAction.setIcon({path:"firebug24_disabled.png"});
};

// *************************************************************************************************

function activateFirebug(tab)
{
    chrome.tabs.update(tab.id, {url: "javascript:localStorage.setItem('Firebug','1,1')"});
    active = true;
};

function deactivateFirebug(tab)
{
    chrome.tabs.update(tab.id, {url: "javascript:localStorage.removeItem('Firebug','1,1')"});
    active = false;
};

// *************************************************************************************************
</script>